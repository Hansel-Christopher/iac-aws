name: 'Terraform Plan/Apply'

on:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  AWS_REGION: "ap-south-1"  # Adjust to your AWS Region

jobs:
  terraform-plan:
    name: 'Terraform Plan'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup AWS Credentials from GitHub OIDC provider
      uses: aws-actions/configure-aws-credentials@v3
      with:
        aws-region: ${{ env.AWS_REGION }}
        role-to-assume: arn:aws:iam::893304181614:role/githubaction-hostedrunner-role
        role-session-name: GitHubActionsSession

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_wrapper: false

    - name: Get changed Terraform files
      id: changed-files
      uses: tj-actions/changed-files@v44
      with:
        files: '**/*.tf'

    - name: Determine changed directories
      id: changed-dirs
      run: |
        CHANGED_DIRS=$(echo "${{ steps.changed-files.outputs.all_changed_files }}" | xargs -n 1 dirname | uniq)
        echo "changed_dirs=$CHANGED_DIRS" >> $GITHUB_ENV

    - name: Terraform operations for each changed directory
      run: |
        for DIR in $CHANGED_DIRS; do
          echo "Running Terraform commands in directory: $DIR"
          cd $DIR
          terraform init
          terraform fmt -check
          terraform plan -detailed-exitcode -no-color -out=tfplan
          terraform show -no-color tfplan > $DIR/tfplan-output.txt
          echo "::set-output name=tfplan_output_path::$DIR/tfplan-output.txt"
        done
        shell: bash

    - name: Upload all Terraform Plans
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plans
        path: '**/tfplan-output.txt'

    - name: Create and Publish Summary Comments
      run: |
        if [ -f "$TFPLAN_OUTPUT_PATH" ]; then
          SUMMARY=$(cat $TFPLAN_OUTPUT_PATH)
          echo "Terraform Plan Output for $DIR:" >> summary.md
          echo '```' >> summary.md
          cat $TFPLAN_OUTPUT_PATH >> summary.md
          echo '```' >> summary.md
        fi

    - name: Push Terraform Output to PR
      if: github.ref != 'refs/heads/main'
      uses: actions/github-script@v7
      with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const summary = fs.readFileSync('./summary.md', 'utf8');
            const body = `ğŸ” **Detailed Terraform Plan Output:**\n${summary}\nPlease review the proposed changes. ğŸ‘€`;
            const comment = await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
            });
            await github.rest.reactions.createForIssueComment({
                comment_id: comment.data.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                content: 'eyes'
            });
